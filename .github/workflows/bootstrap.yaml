name: bootstrap
on: [workflow_call]
jobs:
  bootstrap:
    steps:
      - name: Set autocrlf
        if: runner.os == 'Windows'
        run: git config --global core.autocrlf input

      - name: Checkout pkgsrc
        uses: actions/checkout@v4

      - name: Check for cached bootstrap kit
        id: bootstrap-kit
        uses: actions/cache@v4
        with:
          key: bootstrap-kit-${{ env.platform }}-${{ hashFiles(
            'archivers/libarchive/**', 
            'archivers/pax/**', 
            'bootstrap/bootstrap', 
            'devel/bmake/**', 
            'mk/**', 
            'pkgtools/bootstrap-extras/**', 
            'pkgtools/bootstrap-mk-files/**', 
            'pkgtools/cwrappers/**', 
            'pkgtools/mktools/**', 
            'pkgtools/pkg_install/**', 
            'shells/mksh/**', 
            'sysutils/bsdinstall/**', 
            'sysutils/install-sh/**', 
            'textproc/nbsed/**') }}
          path: ~/bootstrap.tar

      - name: Install cygwin
        uses: egor-tensin/setup-cygwin@v4
        if: runner.os == 'Windows'
        with:
          packages: gcc-g++

      - name: Bootstrap if required
        if: steps.bootstrap-kit.outputs.cache-hit != 'true'
        run: bash ./.github/workflows/bootstrap.sh

      - name: Share bootstrap artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-kit-${{ env.platform }}
          path: ~/bootstrap.tar
