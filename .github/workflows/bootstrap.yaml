name: bootstrap
on: [workflow_call]
jobs:
  bootstrap:
    strategy:
      matrix:
        os:
          - macos-12
          - macos-13
          - macos-14
          - ubuntu-20.04
          - ubuntu-22.04
          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Set autocrlf
        if: runner.os == 'Windows'
        run: git config --global core.autocrlf input

      - name: Checkout pkgsrc
        uses: actions/checkout@v4

      - name: Check for cached bootstrap kit
        id: bootstrap-kit
        uses: actions/cache@v4
        with:
          key: ${{ matrix.os }}-bootstrap-${{ hashFiles(
            'archivers/libarchive/**', 
            'archivers/pax/**', 
            'bootstrap/bootstrap', 
            'devel/bmake/**', 
            'mk/**', 
            'pkgtools/bootstrap-extras/**', 
            'pkgtools/bootstrap-mk-files/**', 
            'pkgtools/cwrappers/**', 
            'pkgtools/mktools/**', 
            'pkgtools/pkg_install/**', 
            'shells/mksh/**', 
            'sysutils/bsdinstall/**', 
            'sysutils/install-sh/**', 
            'textproc/nbsed/**') }}
          path: /tmp/bootstrap.tar

      - name: Install cygwin
        uses: cygwin/cygwin-install-action@master
        if: runner.os == 'Windows'

      - name: Bootstrap if required (non-Windows)
        if: steps.bootstrap-kit.outputs.cache-hit != 'true' && runner.os != 'Windows'
        run: |
          cd ${{ github.workspace }}/bootstrap
          ./bootstrap --prefix=$HOME/pkg --unprivileged --make-jobs=4 --binary-kit=/tmp/bootstrap.tar

      - name: Bootstrap if required (Windows)
        if: steps.bootstrap-kit.outputs.cache-hit != 'true' && runner.os == 'Windows'
        run: |
          cd ${{ github.workspace }}/bootstrap
          ls
          pwd
          env
          bash bootstrap --prefix="$HOME/pkg" --unprivileged --binary-kit=/tmp/bootstrap.tar || true
          find /cygdrive/d/a/pkgsrc/pkgsrc/bootstrap/work
          cat /cygdrive/d/a/pkgsrc/pkgsrc/bootstrap/work/bmake/config.log
          ls /cygdrive/d/a/pkgsrc/pkgsrc/bootstrap/work/bmake/main.c
          head /cygdrive/d/a/pkgsrc/pkgsrc/bootstrap/work/bmake/main.c
          false

      - name: Share bootstrap artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-kit-${{ matrix.os }}
          path: /tmp/bootstrap.tar
